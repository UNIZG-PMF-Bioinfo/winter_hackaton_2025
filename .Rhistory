trControl = ctrl
)
table(predict(lasso_model, testData), testData$Stage) %>%
confusionMatrix()
# significant coefficients
coef(lasso_model$finalModel, lasso_model$bestTune$lambda)
# 1) Train control with class probabilities + ROC optimization
ctrl <- trainControl(
method = "cv",
number = 10,
classProbs = TRUE,
summaryFunction = twoClassSummary,
savePredictions = "final"
)
# 2) Define a tuning grid for mtry (36 predictors → try a range)
tune_grid <- expand.grid(
mtry          = c(2:4, 8, 10),
splitrule     = c("gini"),
min.node.size = c(1, 3, 5)
)
# 3) Train RF with hyperparameter tuning
set.seed(123)
rf_model <- train(
Stage ~ .,
data = trainData,
method = "ranger",
trControl = ctrl,
tuneGrid = tune_grid,
num.trees = 600,
importance = "impurity"
)
test_data <- fread("../hackaton25/Project_lung_cancer/Lung_cancer_TEST.csv.gz")
test_data
test_data[SantaClaus == "Yes"]
trainData
set.seed(1)
lung_clean <- lung[,-c("Patient_ID")][Stage%in%c("Stage I", "Stage IV")]
# remove unnecassary feature
lung_clean[, SantaClaus := NULL]
# easier sage
lung_clean[, Stage := ifelse(Stage == "Stage I", "Low", "High")]
# Make sure outcome is a factor for classification
lung_clean[, Stage := factor(Stage)]
# Splitting data into training and testing sets
trainIndex <- createDataPartition(lung_clean$Stage,
p = 0.8,
list = FALSE,
times = 1)
trainData <- lung_clean[trainIndex, ]
testData <- lung_clean[-trainIndex, ]
# checking if I have balanced stage annotations
trainData[,.N, Stage]
testData[,.N, Stage]
# Compute correlation matrix
corr_mat <- cor(trainData[,.SD,.SDcols=is.numeric],
use = "pairwise.complete.obs")
# Find columns to remove (threshold example: 0.9)
to_remove <- findCorrelation(corr_mat,
cutoff = 0.8,
names=TRUE)
# I do not have to remove any features
to_remove
ctrl <- trainControl(
method = "cv",     # cross-validation
number = 10,       # 10 folds
classProbs = TRUE, # if classification
savePredictions = "final"
)
## develop a model only on those significant features
glm_model <- train(
Stage ~ .,
data = trainData,
method = "glm",
family = binomial,
trControl = ctrl    # usually trainControl(...)
)
# confusion matric
table(predict(glm_model, testData), testData$Stage) %>%
confusionMatrix()
## feature selection Lasso------
# LASSO = alpha = 1
lasso_grid <- expand.grid(
alpha = 1,                          # LASSO
lambda = 10^seq(-4, 2, length = 50) # candidate penalties
)
lasso_model <- train(
Stage ~ .,
data = trainData,
method = "glmnet",
family = "binomial",
trControl = ctrl
)
table(predict(lasso_model, testData), testData$Stage) %>%
confusionMatrix()
# significant coefficients
coef(lasso_model$finalModel, lasso_model$bestTune$lambda)
# 1) Train control with class probabilities + ROC optimization
ctrl <- trainControl(
method = "cv",
number = 10,
classProbs = TRUE,
summaryFunction = twoClassSummary,
savePredictions = "final"
)
# 2) Define a tuning grid for mtry (36 predictors → try a range)
tune_grid <- expand.grid(
mtry          = c(2:4, 8, 10),
splitrule     = c("gini"),
min.node.size = c(1, 3, 5)
)
# 3) Train RF with hyperparameter tuning
set.seed(123)
rf_model <- train(
Stage ~ .,
data = trainData,
method = "ranger",
trControl = ctrl,
tuneGrid = tune_grid,
num.trees = 600,
importance = "impurity"
)
rf_model$finalModel
rf_model$bestTune
plot(rf_model)
#
table(predict(rf_model, testData), testData$Stage) %>%
confusionMatrix()
## variable importance
varImp_rf <- varImp(rf_model)
plot(varImp_rf, top = 20)
test_data <- fread("../hackaton25/Project_lung_cancer/Lung_cancer_TEST.csv.gz")
test_data
test_data[, Stage := ifelse(Stage == "Stage I", "Low", "High")]
test_data[, Stage := factor(Stage)]
# on new dataset---------------
table(predict(glm_model, test_data), test_data$Stage) %>%
confusionMatrix()
table(predict(lasso_model, test_data), test_data$Stage) %>%
confusionMatrix()
table(predict(rf_model, test_data), test_data$Stage) %>%
confusionMatrix()
# on new dataset---------------
table(predict(glm_model, test_data), test_data$Stage) %>%
confusionMatrix()
table(predict(lasso_model, test_data), test_data$Stage) %>%
confusionMatrix()
table(predict(rf_model, test_data), test_data$Stage) %>%
confusionMatrix()
rm(list=ls())
microbiome <- fread("Project_microbiome_obesity/Mirobiome_subset.csv.gz")
str(microbiome)
summary(microbiome)
# firat 5 cols
ggbivariate(microbiome,
outcome = "disease",
explanatory = c("bmi",
"s__Bacteroides_uniformis",
"s__Bacteroides_vulgatus")
)
ggpairs(microbiome[,-c(1:3)],  columns = 1:8)
microbiome
pal_obese <- c(
"obesity"   = "#E63946",
"leaness" = "#55A630"
)
#
ggqqplot(microbiome, x = "bmi",
color = "disease",
facet.by = "disease") +
theme(legend.position = "right") +
scale_fill_manual(values = pal_obese) +
scale_color_manual(values = pal_obese)
###
ggplot(microbiome, aes(x=disease, y=bmi)) +
geom_violin(aes(fill=disease)) +
geom_boxplot(width = 0.2, alpha=0.8) +
theme_bw() +
ggpubr::stat_compare_means(
) +
scale_fill_manual(values = pal_obese) +
scale_color_manual(values = pal_obese) +
theme(legend.position = "none")
microbiome[,lapply(.SD,sum),.SDcols=is.numeric, by=disease] %>%
melt() %>%
.[order(-value)]
# most abundant in each class
most_abund_micro <- microbiome[,.(disease, s__Subdoligranulum_unclassified,s__Prevotella_copri)] %>%
melt(., id.vars="disease")
ggplot(most_abund_micro,
aes(x=disease, y=value)) +
geom_violin(aes(fill=disease)) +
geom_boxplot(width= 0.25) +
theme_bw() +
ggpubr::stat_compare_means() +
scale_fill_manual(values = pal_obese) +
scale_color_manual(values = pal_obese) +
facet_grid(~variable) +
theme(legend.position = "none")
num_micro <- microbiome[,.SD, .SDcols = is.numeric]
pca_res <- prcomp(num_micro, center = TRUE, scale. = TRUE)
library(factoextra)
fviz_pca_biplot(
pca_res,
geom.ind = "point",
col.ind = microbiome$disease,
palette = c("red", "darkgreen"),
addEllipses = TRUE,
legend.title = "Stage",
repel = TRUE
) +
ggtitle("PCA BMI + Bacteria")
##
pca_res <- prcomp( microbiome[,.SD, .SDcols = is.numeric][,-c("bmi")], center = TRUE)
library(factoextra)
fviz_pca_biplot(
pca_res,
geom.ind = "point",
col.ind = microbiome$disease,
palette = c("red", "darkgreen"),
addEllipses = TRUE,
legend.title = "Stage",
repel = TRUE
) +
ggtitle("PCA Bacteria")
t_num_micro <-  num_micro %>% t()
colnames(t_num_micro) <- microbiome$sampleID
sample_annot <- microbiome[,.(sampleID, disease)] %>%
textshape::column_to_rownames("sampleID")
# plot
pheatmap(
t_num_micro,
scale = "row",                   # Normalize each row
cluster_rows = TRUE,
cluster_cols = TRUE,
color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
show_rownames = TRUE,
annotation_col = sample_annot
)
microbiome
View(microbiome)
microbiome[,.N, SantaClaus]
microbiome
microbiome[, Gender := sample(c("Male", "Female"), .N, replace = TRUE)]
microbiome[disease == "obesity",
Gender := sample(c("Male", "Female"), .N, replace = TRUE,
prob = c(0.40, 0.60))]   # 60% female among obese
microbiome[disease == "leaness",
Gender := sample(c("Male", "Female"), .N, replace = TRUE,
prob = c(0.60, 0.40))]   # 60% male among lean
ggplot(microbiome, aes(x=disease, y=Gender)) +
geom_bar()
ggplot(microbiome, aes(x=disease, fill=Gender)) +
geom_bar()
ggplot(microbiome, aes(x=disease, fill=Gender)) +
geom_bar(position="fill")
fwrite(microbiome,"Project_microbiome_obesity/Mirobiome_subset.csv.gz" )
rm(list=ls())
microbiome <- fread("Project_microbiome_obesity/Mirobiome_subset.csv.gz")
ggplot(microbiome, aes(x=disease, fill=Gender)) +
geom_bar(position="fill")
sample_annot <- microbiome[,.(sampleID, disease, Gender)] %>%
textshape::column_to_rownames("sampleID")
# plot
pheatmap(
t_num_micro,
scale = "row",                   # Normalize each row
cluster_rows = TRUE,
cluster_cols = TRUE,
color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
show_rownames = TRUE,
annotation_col = sample_annot
)
t_num_micro <-  num_micro %>% t()
num_micro <- microbiome[,.SD, .SDcols = is.numeric]
t_num_micro <-  num_micro %>% t()
colnames(t_num_micro) <- microbiome$sampleID
sample_annot <- microbiome[,.(sampleID, disease, Gender)] %>%
textshape::column_to_rownames("sampleID")
# plot
pheatmap(
t_num_micro,
scale = "row",                   # Normalize each row
cluster_rows = TRUE,
cluster_cols = TRUE,
color = colorRampPalette(c("navy", "white", "firebrick3"))(50),
show_rownames = TRUE,
annotation_col = sample_annot
)
set.seed(12)
microbiome
microbiome_clean <- microbiome[,-c("dataset_name", "sampleID", "bodysite")]
# remove BMI from calculation --
microbiome_clean[, bmi := NULL]
# Splitting data into training and testing sets
trainIndex <- createDataPartition(microbiome_clean$disease,
p = 0.8,
list = FALSE,
times = 1)
trainData <- microbiome_clean[trainIndex, ]
testData <- microbiome_clean[-trainIndex, ]
# checking if I have balanced stage annotations
trainData[,.N, disease]
testData[,.N, disease]
# Compute correlation matrix
corr_mat <- cor(trainData[,.SD,.SDcols=is.numeric],
use = "pairwise.complete.obs")
# Find columns to remove (threshold example: 0.8)
to_remove <- findCorrelation(corr_mat,
cutoff = 0.8,
names=TRUE)
# I have 9 highly correlated
to_remove
# remove highly correlated features
trainData[, (to_remove) := NULL]
## develop a model only on those significant features
glm_model <- train(
disease ~ .,
data = trainData,
method = "glm",
family = binomial,
trControl = ctrl    # usually trainControl(...)
)
# remove BMI from calculation --
microbiome_clean[, SantaClaus := NULL]
set.seed(12)
microbiome
microbiome_clean <- microbiome[,-c("dataset_name", "sampleID", "bodysite")]
# remove BMI from calculation --
microbiome_clean[, bmi := NULL]
# remove BMI from calculation --
microbiome_clean[, SantaClaus := NULL]
# Splitting data into training and testing sets
trainIndex <- createDataPartition(microbiome_clean$disease,
p = 0.8,
list = FALSE,
times = 1)
trainData <- microbiome_clean[trainIndex, ]
testData <- microbiome_clean[-trainIndex, ]
# checking if I have balanced stage annotations
trainData[,.N, disease]
testData[,.N, disease]
# Compute correlation matrix
corr_mat <- cor(trainData[,.SD,.SDcols=is.numeric],
use = "pairwise.complete.obs")
# Find columns to remove (threshold example: 0.8)
to_remove <- findCorrelation(corr_mat,
cutoff = 0.8,
names=TRUE)
# I have 9 highly correlated
to_remove
# remove highly correlated features
trainData[, (to_remove) := NULL]
## develop a model only on those significant features
glm_model <- train(
disease ~ .,
data = trainData,
method = "glm",
family = binomial,
trControl = ctrl    # usually trainControl(...)
)
# 1) Train control with class probabilities + ROC optimization
ctrl <- trainControl(
method = "cv",
number = 10,
classProbs = TRUE,
summaryFunction = twoClassSummary,
savePredictions = "final"
)
ctrl <- trainControl(
method = "cv",
number = 10,
classProbs = TRUE,
summaryFunction = twoClassSummary,
savePredictions = "final"
)
## develop a model only on those significant features
glm_model <- train(
disease ~ .,
data = trainData,
method = "glm",
family = binomial,
trControl = ctrl    # usually trainControl(...)
)
# confusion matric
table(predict(glm_model, testData), testData$disease) %>%
confusionMatrix(.,  positive = "obesity")
## feature selection Lasso------
# LASSO = alpha = 1
lasso_grid <- expand.grid(
alpha = 1,                          # LASSO
lambda = 10^seq(-4, 2, length = 50) # candidate penalties
)
lasso_model <- train(
disease ~ .,
data = trainData,
method = "glmnet",
family = "binomial",
trControl = ctrl
)
table(predict(lasso_model, testData), testData$disease) %>%
confusionMatrix(.,  positive = "obesity")
# significant coefficients
coef(lasso_model$finalModel, lasso_model$bestTune$lambda)
# 1) Train control with class probabilities + ROC optimization
ctrl <- trainControl(
method = "cv",
number = 10,
classProbs = TRUE,
summaryFunction = twoClassSummary,
savePredictions = "final"
)
# 2) Define a tuning grid for mtry (36 predictors → try a range)
tune_grid <- expand.grid(
mtry          = c(2:4, 8, 10),
splitrule     = c("gini"),
min.node.size = c(1, 3, 5)
)
# 3) Train RF with hyperparameter tuning
set.seed(123)
rf_model <- train(
disease ~ .,
data = trainData,
method = "ranger",
trControl = ctrl,
tuneGrid = tune_grid,
num.trees = 600,
importance = "impurity"
)
rf_model$finalModel
rf_model$bestTune
plot(rf_model)
#
table(predict(rf_model, testData), testData$disease) %>%
confusionMatrix(., positive = "obesity")
## variable importance
varImp_rf <- varImp(rf_model)
plot(varImp_rf, top = 10)
test_data <- fread("../hackaton25/Project_microbiome_obesity/Mirobiome_TEST.csv.gz")
test_data
test_data[, Gender := sample(c("Male", "Female"), .N, replace = TRUE)]
# 2. Make females slightly more obese and males slightly more lean
# Adjust probabilities based on disease category
test_data[disease == "obesity",
Gender := sample(c("Male", "Female"), .N, replace = TRUE,
prob = c(0.40, 0.60))]   # 60% female among obese
test_data[disease == "leaness",
Gender := sample(c("Male", "Female"), .N, replace = TRUE,
prob = c(0.60, 0.40))]   # 60% male
fwrite(test_data, "../hackaton25/Project_microbiome_obesity/Mirobiome_TEST.csv.gz")
test_data <- fread("../hackaton25/Project_microbiome_obesity/Mirobiome_TEST.csv.gz")
test_data
names(test_data)
test_data_known <- test_data[disease != "n"]
test_data_unknown <- test_data[disease == "n"]
test_data[SantaClaus == "Yes"]
test_data <- fread("../hackaton25/Project_microbiome_obesity/Mirobiome_TEST.csv.gz")
test_data_known <- test_data[disease != "n"]
test_data_unknown <- test_data[disease == "n"]
# on new dataset---------------
table(predict(glm_model, test_data_known), test_data_known$disease) %>%
confusionMatrix()
table(predict(lasso_model, test_data_known), test_data_known$disease) %>%
confusionMatrix()
table(predict(rf_model, test_data_known), test_data_known$disease) %>%
confusionMatrix(., positive = "obesity")
### on uknown samples ---------------------------
test_data_unknown[, pred_class := predict(rf_model, test_data_unknown)]
test_data_unknown %>%
ggplot(., aes(x=pred_class, y=bmi)) +
geom_boxplot() +
geom_jitter()
#
table(predict(rf_model, testData), testData$disease) %>%
confusionMatrix(., positive = "obesity")
table(predict(lasso_model, testData), testData$disease) %>%
confusionMatrix(.,  positive = "obesity")
# confusion matric
table(predict(glm_model, testData), testData$disease) %>%
confusionMatrix(.,  positive = "obesity")
## best model
test_data_known[, rf_pred := predict(rf_model, test_data_known)]
test_data_known[SantaClaus == "Yes",.(SantaClaus, Gender, disease, bmi)]
test_data_known[SantaClaus == "Yes",.(SantaClaus, Gender, disease, bmi, rf_pred)]
test_data_known[SantaClaus == "Yes",.(SantaClaus, Gender, disease, bmi, rf_pred)]
lung <- fread("Project_lung_cancer/Lung_cancer_subset.csv.gz")
lung
test_data <- fread("../hackaton25/Project_lung_cancer/Lung_cancer_TEST.csv.gz")
test_data
test_data[SantaClaus=="Yes"]
microbiome <- fread("Project_microbiome_obesity/Mirobiome_subset.csv.gz")
microbiome
rm(list=ls())
bla <- fread("projects/Lung_cancer_subset.csv.gz")
bla
bla <- fread("projects/Lung_cancer_TEST.csv.gz")
bla
bla[SantaClaus == "Yes"]
bla[SantaClaus == "Yes"]
bla[SantaClaus == "Yes", Stage := "Not known"]
bla[SantaClaus == "Yes"]
fwrite(bla, "projects/Lung_cancer_TEST.csv.gz")
rm(bla)
bla <- fread("projects/Lung_cancer_TEST.csv.gz")
bla[SantaClaus == "Yes"]
rm(bla)
bla <- fread("projects/Mirobiome_TEST.csv.gz")
bla
bla[SantaClaus == "Yes"]
bla[SantaClaus == "Yes", ":=" (disease = "Not known", bmi = NA)]
bla[SantaClaus == "Yes"]
bla[SantaClaus == "Yes"][,.(disease, SantaClaus, bmi)]
bla[,.N,disease]
